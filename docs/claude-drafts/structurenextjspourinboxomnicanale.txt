# Skybot Inbox - Frontend Squelette Next.js

Je vais cr√©er une structure frontend compl√®te et fonctionnelle pour votre inbox omnicanale. Je vais proc√©der par √©tapes logiques.

## 1. Configuration de base et utilities

### `frontend/lib/apiClient.ts`

```typescript
/**
 * API Client pour Skybot Inbox
 * G√®re les appels HTTP vers le backend NestJS avec authentification JWT
 */

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api';

interface ApiError {
  message: string;
  statusCode: number;
}

/**
 * R√©cup√®re le token JWT depuis localStorage
 */
function getToken(): string | null {
  if (typeof window === 'undefined') return null;
  return localStorage.getItem('skybot_token');
}

/**
 * Sauvegarde le token JWT dans localStorage
 */
export function setToken(token: string): void {
  localStorage.setItem('skybot_token', token);
}

/**
 * Supprime le token JWT (logout)
 */
export function removeToken(): void {
  localStorage.removeItem('skybot_token');
}

/**
 * Wrapper fetch avec gestion automatique du token JWT
 * et parsing JSON des erreurs
 */
export async function apiClient<T>(
  endpoint: string,
  options: RequestInit = {}
): Promise<T> {
  const token = getToken();
  
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    ...options.headers,
  };

  // Ajouter le token si disponible
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
    ...options,
    headers,
  });

  // Gestion des erreurs HTTP
  if (!response.ok) {
    let errorMessage = `Erreur ${response.status}`;
    try {
      const errorData: ApiError = await response.json();
      errorMessage = errorData.message || errorMessage;
    } catch {
      // Si le parsing JSON √©choue, garder le message par d√©faut
    }

    // Si 401 Unauthorized, rediriger vers login
    if (response.status === 401) {
      removeToken();
      if (typeof window !== 'undefined') {
        window.location.href = '/login';
      }
    }

    throw new Error(errorMessage);
  }

  // Retourner les donn√©es JSON
  return response.json();
}

/**
 * M√©thodes HTTP helper
 */
export const api = {
  get: <T>(endpoint: string) => 
    apiClient<T>(endpoint, { method: 'GET' }),
  
  post: <T>(endpoint: string, data?: unknown) =>
    apiClient<T>(endpoint, {
      method: 'POST',
      body: data ? JSON.stringify(data) : undefined,
    }),
  
  put: <T>(endpoint: string, data?: unknown) =>
    apiClient<T>(endpoint, {
      method: 'PUT',
      body: data ? JSON.stringify(data) : undefined,
    }),
  
  delete: <T>(endpoint: string) =>
    apiClient<T>(endpoint, { method: 'DELETE' }),
};
```

### `frontend/lib/queryClient.ts`

```typescript
/**
 * Configuration React Query pour Skybot Inbox
 * G√®re le cache et les refetch automatiques
 */

import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // Refetch quand la fen√™tre reprend le focus
      refetchOnWindowFocus: true,
      // Refetch toutes les 30 secondes pour les conversations
      refetchInterval: 30000,
      // Garder les donn√©es en cache 5 minutes
      staleTime: 5 * 60 * 1000,
      // Retry une seule fois en cas d'erreur
      retry: 1,
    },
    mutations: {
      // Pas de retry automatique pour les mutations
      retry: false,
    },
  },
});
```

### `frontend/lib/types.ts`

```typescript
/**
 * Types TypeScript pour les entit√©s Skybot Inbox
 * Doivent correspondre aux DTOs du backend NestJS
 */

export interface User {
  id: string;
  email: string;
  name: string;
  accountId: string;
  createdAt: string;
}

export interface Inbox {
  id: string;
  name: string;
  channel: 'WHATSAPP' | 'EMAIL' | 'FACEBOOK' | 'INSTAGRAM';
  accountId: string;
}

export interface Contact {
  id: string;
  name?: string;
  phoneNumber?: string;
  email?: string;
  accountId: string;
}

export enum ConversationStatus {
  OPEN = 'OPEN',
  RESOLVED = 'RESOLVED',
  PENDING = 'PENDING',
}

export interface Conversation {
  id: string;
  status: ConversationStatus;
  inboxId: string;
  contactId: string;
  lastMessageAt: string;
  unreadCount?: number;
  contact?: Contact;
  inbox?: Inbox;
}

export enum MessageType {
  INCOMING = 'INCOMING',
  OUTGOING = 'OUTGOING',
}

export enum SenderType {
  CONTACT = 'CONTACT',
  AGENT = 'AGENT',
  BOT = 'BOT',
}

export interface Message {
  id: string;
  conversationId: string;
  content: string;
  messageType: MessageType;
  senderType: SenderType;
  createdAt: string;
  userId?: string;
}

export interface AuthResponse {
  access_token: string;
  user: User;
}

export interface LoginCredentials {
  email: string;
  password: string;
}

export interface RegisterData {
  email: string;
  password: string;
  name: string;
  accountName: string;
}
```

## 2. Layout et structure de l'application

### `frontend/app/layout.tsx`

```typescript
/**
 * Layout racine de l'application Next.js
 * Configure React Query Provider et les styles globaux
 */

import './globals.css';
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import { QueryClientProvider } from '@tanstack/react-query';
import { queryClient } from '@/lib/queryClient';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Skybot Inbox',
  description: 'Inbox omnicanale B2B',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="fr">
      <body className={inter.className}>
        <QueryClientProvider client={queryClient}>
          {children}
        </QueryClientProvider>
      </body>
    </html>
  );
}
```

### `frontend/app/globals.css`

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
  }

  body {
    @apply bg-gray-50 text-gray-900;
  }
}
```

### `frontend/components/layout/AppShell.tsx`

```typescript
/**
 * Layout principal de l'application (Dashboard)
 * Structure: Header + Sidebar + Main content
 */

'use client';

import { ReactNode } from 'react';
import { useRouter } from 'next/navigation';
import { removeToken } from '@/lib/apiClient';

interface AppShellProps {
  children: ReactNode;
  sidebar?: ReactNode;
}

export default function AppShell({ children, sidebar }: AppShellProps) {
  const router = useRouter();

  const handleLogout = () => {
    removeToken();
    router.push('/login');
  };

  return (
    <div className="h-screen flex flex-col">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 h-16 flex items-center px-6 justify-between">
        <div className="flex items-center space-x-4">
          <h1 className="text-xl font-bold text-blue-600">Skybot Inbox</h1>
        </div>
        
        <button
          onClick={handleLogout}
          className="text-sm text-gray-600 hover:text-gray-900"
        >
          D√©connexion
        </button>
      </header>

      {/* Main layout */}
      <div className="flex-1 flex overflow-hidden">
        {/* Sidebar (optionnel) */}
        {sidebar && (
          <aside className="w-64 bg-white border-r border-gray-200 overflow-y-auto">
            {sidebar}
          </aside>
        )}

        {/* Main content */}
        <main className="flex-1 overflow-hidden">
          {children}
        </main>
      </div>
    </div>
  );
}
```

## 3. Pages d'authentification

### `frontend/app/(auth)/login/page.tsx`

```typescript
/**
 * Page de connexion
 * POST /api/auth/login
 */

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { api, setToken } from '@/lib/apiClient';
import { AuthResponse, LoginCredentials } from '@/lib/types';

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      const credentials: LoginCredentials = { email, password };
      const response = await api.post<AuthResponse>('/auth/login', credentials);
      
      // Sauvegarder le token JWT
      setToken(response.access_token);
      
      // Rediriger vers le dashboard
      router.push('/dashboard');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erreur de connexion');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            Skybot Inbox
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            Connectez-vous √† votre compte
          </p>
        </div>

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          {error && (
            <div className="rounded-md bg-red-50 p-4">
              <p className="text-sm text-red-800">{error}</p>
            </div>
          )}

          <div className="rounded-md shadow-sm -space-y-px">
            <div>
              <label htmlFor="email" className="sr-only">
                Email
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="Email"
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                Mot de passe
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="Mot de passe"
              />
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
            >
              {loading ? 'Connexion...' : 'Se connecter'}
            </button>
          </div>

          <div className="text-center">
            <Link
              href="/register"
              className="text-sm text-blue-600 hover:text-blue-500"
            >
              Pas encore de compte ? S'inscrire
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}
```

### `frontend/app/(auth)/register/page.tsx`

```typescript
/**
 * Page d'inscription
 * POST /api/auth/register
 */

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { api, setToken } from '@/lib/apiClient';
import { AuthResponse, RegisterData } from '@/lib/types';

export default function RegisterPage() {
  const router = useRouter();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    name: '',
    accountName: '',
  });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      [e.target.name]: e.target.value,
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      const registerData: RegisterData = formData;
      const response = await api.post<AuthResponse>('/auth/register', registerData);
      
      // Sauvegarder le token JWT
      setToken(response.access_token);
      
      // Rediriger vers le dashboard
      router.push('/dashboard');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erreur lors de l\'inscription');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            Cr√©er un compte Skybot Inbox
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            Commencez √† g√©rer vos conversations
          </p>
        </div>

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          {error && (
            <div className="rounded-md bg-red-50 p-4">
              <p className="text-sm text-red-800">{error}</p>
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label htmlFor="accountName" className="block text-sm font-medium text-gray-700">
                Nom de l'entreprise
              </label>
              <input
                id="accountName"
                name="accountName"
                type="text"
                required
                value={formData.accountName}
                onChange={handleChange}
                className="mt-1 appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="Mon Entreprise"
              />
            </div>

            <div>
              <label htmlFor="name" className="block text-sm font-medium text-gray-700">
                Votre nom
              </label>
              <input
                id="name"
                name="name"
                type="text"
                required
                value={formData.name}
                onChange={handleChange}
                className="mt-1 appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="Jean Dupont"
              />
            </div>

            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                Email
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                value={formData.email}
                onChange={handleChange}
                className="mt-1 appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="vous@exemple.com"
              />
            </div>

            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                Mot de passe
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="new-password"
                required
                value={formData.password}
                onChange={handleChange}
                className="mt-1 appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
            >
              {loading ? 'Cr√©ation...' : 'Cr√©er mon compte'}
            </button>
          </div>

          <div className="text-center">
            <Link
              href="/login"
              className="text-sm text-blue-600 hover:text-blue-500"
            >
              D√©j√† un compte ? Se connecter
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}
```

## 4. Composants Inbox

### `frontend/components/inbox/InboxSidebar.tsx`

```typescript
/**
 * Sidebar affichant la liste des inboxes
 * GET /api/inboxes
 */

'use client';

import { useQuery } from '@tanstack/react-query';
import { api } from '@/lib/apiClient';
import { Inbox } from '@/lib/types';

const channelIcons: Record<string, string> = {
  WHATSAPP: 'üí¨',
  EMAIL: 'üìß',
  FACEBOOK: 'üë•',
  INSTAGRAM: 'üì∑',
};

export default function InboxSidebar() {
  const { data: inboxes, isLoading, error } = useQuery({
    queryKey: ['inboxes'],
    queryFn: () => api.get<Inbox[]>('/inboxes'),
  });

  if (isLoading) {
    return (
      <div className="p-4">
        <div className="animate-pulse space-y-3">
          {[1, 2, 3].map((i) => (
            <div key={i} className="h-12 bg-gray-200 rounded"></div>
          ))}
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-4">
        <p className="text-sm text-red-600">Erreur de chargement</p>
      </div>
    );
  }

  return (
    <div className="p-4">
      <h2 className="text-sm font-semibold text-gray-900 mb-4">Mes Inboxes</h2>
      
      {inboxes && inboxes.length === 0 && (
        <p className="text-sm text-gray-500">Aucune inbox configur√©e</p>
      )}

      <div className="space-y-2">
        {inboxes?.map((inbox) => (
          <div
            key={inbox.id}
            className="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors"
          >
            <span className="text-2xl">
              {channelIcons[inbox.channel] || 'üì®'}
            </span>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-gray-900 truncate">
                {inbox.name}
              </p>
              <p className="text-xs text-gray-500">{inbox.channel}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### `frontend/components/inbox/ConversationItem.tsx`

```typescript
/**
 * Item individuel dans la liste des conversations
 */

'use client';

import { Conversation } from '@/lib/types';
import { formatDistanceToNow } from 'date-fns';
import { fr } from 'date-fns/locale';

interface ConversationItemProps {
  conversation: Conversation;
  isActive: boolean;
  onClick: () => void;
}

export default function ConversationItem({
  conversation,
  isActive,
  onClick,
}: ConversationItemProps) {
  const contactName = conversation.contact?.name || 
                     conversation.contact?.phoneNumber || 
                     conversation.contact?.email || 
                     'Contact inconnu';

  const timeAgo = formatDistanceToNow(new Date(conversation.lastMessageAt), {
    addSuffix: true,
    locale: fr,
  });

  return (
    <div
      onClick={onClick}
      className={`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${
        isActive ? 'bg-blue-50 border-l-4 border-l-blue-600' : ''
      }`}
    >
      <div className="flex items-start justify-between">
        <div className="flex-1 min-w-0">
          <p className="text-sm font-medium text-gray-900 truncate">
            {contactName}
          </p>
          <p className="text-xs text-gray-500 mt-1">{timeAgo}</p>
        </div>
        
        {conversation.unreadCount && conversation.unreadCount > 0 && (
          <span className="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-blue-600 rounded-full">
            {conversation.unreadCount}
          </span>
        )}
      </div>

      <div className="mt-2">
        <span
          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
            conversation.status === 'OPEN'
              ? 'bg-green-100 text-green-800'
              : conversation.status === 'RESOLVED'
              ? 'bg-gray-100 text-gray-800'
              : 'bg-yellow-100 text-yellow-800'
          }`}
        >
          {conversation.status}
        </span>
      </div>
    </div>
  );
}
```

### `frontend/components/inbox/ConversationList.tsx`

```typescript
/**
 * Liste des conversations
 * GET /api/conversations?status=OPEN
 */

'use client';

import { useQuery } from '@tanstack/react-query';
import { api } from '@/lib/apiClient';
import { Conversation } from '@/lib/types';
import ConversationItem from './ConversationItem';

interface ConversationListProps {
  selectedConversationId?: string;
  onSelectConversation: (conversationId: string) => void;
}

export default function ConversationList({
  selectedConversationId,
  onSelectConversation,
}: ConversationListProps) {
  const { data: conversations, isLoading, error } = useQuery({
    queryKey: ['conversations', 'OPEN'],
    queryFn: () => api.get<Conversation[]>('/conversations?status=OPEN'),
    // Refetch toutes les 10 secondes pour cette liste
    refetchInterval: 10000,
  });

  if (isLoading) {
    return (
      <div className="h-full flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-full flex items-center justify-center p-4">
        <p className="text-sm text-red-600">Erreur de chargement</p>
      </div>
    );
  }

  if (!conversations || conversations.length === 0) {
    return (
      <div className="h-full flex items-center justify-center p-4">
        <p className="text-sm text-gray-500">Aucune conversation ouverte</p>
      </div>
    );
  }

  return (
    <div className="h-full overflow-y-auto">
      {conversations.map((conversation) => (
        <ConversationItem
          key={conversation.id}
          conversation={conversation}
          isActive={conversation.id === selectedConversationId}
          onClick={() => onSelectConversation(conversation.id)}
        />
      ))}
    </div>
  );
}
```

### `frontend/components/inbox/MessageList.tsx`

```typescript
/**
 * Liste des messages d'une conversation
 * GET /api/conversations/:id/messages
 */

'use client';

import { useQuery } from '@tanstack/react-query';
import { useEffect, useRef } from 'react';
import { api } from '@/lib/apiClient';
import { Message } from '@/lib/types';
import { format } from 'date-fns';
import { fr } from 'date-fns/locale';

interface MessageListProps {
  conversationId: string;
}

export default function MessageList({ conversationId }: MessageListProps) {
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const { data: messages, isLoading } = useQuery({
    queryKey: ['messages', conversationId],
    queryFn: () => api.get<Message[]>(`/conversations/${conversationId}/messages`),
    enabled: !!conversationId,
    // Refetch toutes les 5 secondes
    refetchInterval: 5000,
  });

  // Auto-scroll vers le bas quand de nouveaux messages arrivent
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  if (isLoading) {
    return (
      <div className="h-full flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (!messages || messages.length === 0) {
    return (
      <div className="h-full flex items-center justify-center">
        <p className="text-sm text-gray-500">Aucun message</p>
      </div>
    );
  }

  return (
    <div className="h-full overflow-y-auto p-4 space-y-4">
      {messages.map((message) => {
        const isOutgoing = message.messageType === 'OUTGOING';
        const isBot = message.senderType === 'BOT';

        return (
          <div
            key={message.id}
            className={`flex ${isOutgoing ? 'justify-end' : 'justify-start'}`}
          >
            <div
              className={`max-w-md px-4 py-2 rounded-lg ${
                isOutgoing
                  ? isBot
                    ? 'bg-purple-100 text-purple-900'
                    : 'bg-blue-600 text-white'
                  : 'bg-gray-200 text-gray-900'
              }`}
            >
              <p className="text-sm whitespace-pre-wrap">{message.content}</p>
              
              <div className="flex items-center justify-between mt-2 space-x-2">
                <span className="text-xs opacity-75">
                  {format(new Date(message.createdAt), 'HH:mm', { locale: fr })}
                </span>
                
                {isBot && (
                  <span className="text-xs font-medium opacity-75">BOT</span>
                )}
                {message.senderType === 'AGENT' && (
                  <span className="text-xs font-medium opacity-75">AGENT</span>
                )}
              </div>
            </div>
          </div>
        );
      })}
      <div ref={messagesEndRef} />
    </div>
  );
}
```

### `frontend/components/inbox/MessageComposer.tsx`

```typescript
/**
 * Formulaire d'envoi de message
 * POST /api/conversations/:id/messages
 */

'use client';

import { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { api } from '@/lib/apiClient';
import { Message } from '@/lib/types';

interface MessageComposerProps {
  conversationId: string;
}

export default function MessageComposer({ conversationId }: MessageComposerProps) {
  const [content, setContent] = useState('');
  const queryClient = useQueryClient();

  ```typescript
  const sendMessageMutation = useMutation({
    mutationFn: (messageContent: string) =>
      api.post<Message>(`/conversations/${conversationId}/messages`, {
        content: messageContent,
      }),
    onSuccess: () => {
      // Vider le champ de saisie
      setContent('');
      
      // Invalider le cache des messages pour refetch automatiquement
      queryClient.invalidateQueries({
        queryKey: ['messages', conversationId],
      });
      
      // Invalider aussi la liste des conversations (pour mettre √† jour lastMessageAt)
      queryClient.invalidateQueries({
        queryKey: ['conversations'],
      });
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!content.trim()) return;
    
    sendMessageMutation.mutate(content);
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    // Envoyer avec Ctrl+Enter ou Cmd+Enter
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="border-t border-gray-200 p-4">
      {sendMessageMutation.error && (
        <div className="mb-3 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-800">
          {sendMessageMutation.error instanceof Error
            ? sendMessageMutation.error.message
            : 'Erreur lors de l\'envoi'}
        </div>
      )}

      <div className="flex items-end space-x-3">
        <div className="flex-1">
          <textarea
            value={content}
            onChange={(e) => setContent(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Tapez votre message... (Ctrl+Enter pour envoyer)"
            rows={3}
            disabled={sendMessageMutation.isPending}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none disabled:opacity-50"
          />
        </div>

        <button
          type="submit"
          disabled={!content.trim() || sendMessageMutation.isPending}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {sendMessageMutation.isPending ? (
            <span className="flex items-center">
              <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Envoi...
            </span>
          ) : (
            'Envoyer'
          )}
        </button>
      </div>

      <p className="mt-2 text-xs text-gray-500">
        Astuce : Utilisez Ctrl+Enter pour envoyer rapidement
      </p>
    </form>
  );
}
```

## 5. Page Dashboard principale

### `frontend/app/dashboard/page.tsx`

```typescript
/**
 * Page principale du dashboard (Inbox)
 * Layout : Sidebar (Inboxes) | Liste conversations | Conversation active
 */

'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import AppShell from '@/components/layout/AppShell';
import InboxSidebar from '@/components/inbox/InboxSidebar';
import ConversationList from '@/components/inbox/ConversationList';
import MessageList from '@/components/inbox/MessageList';
import MessageComposer from '@/components/inbox/MessageComposer';

export default function DashboardPage() {
  const router = useRouter();
  const [selectedConversationId, setSelectedConversationId] = useState<string | null>(null);

  // V√©rifier l'authentification au chargement
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const token = localStorage.getItem('skybot_token');
      if (!token) {
        router.push('/login');
      }
    }
  }, [router]);

  return (
    <AppShell sidebar={<InboxSidebar />}>
      <div className="h-full flex">
        {/* Colonne liste des conversations */}
        <div className="w-80 border-r border-gray-200 bg-white">
          <div className="h-16 border-b border-gray-200 flex items-center px-4">
            <h2 className="text-lg font-semibold text-gray-900">
              Conversations
            </h2>
          </div>
          
          <ConversationList
            selectedConversationId={selectedConversationId || undefined}
            onSelectConversation={setSelectedConversationId}
          />
        </div>

        {/* Colonne conversation active */}
        <div className="flex-1 flex flex-col bg-white">
          {selectedConversationId ? (
            <>
              {/* Header de la conversation */}
              <div className="h-16 border-b border-gray-200 flex items-center px-6">
                <h3 className="text-lg font-medium text-gray-900">
                  Conversation
                </h3>
              </div>

              {/* Messages */}
              <div className="flex-1 overflow-hidden">
                <MessageList conversationId={selectedConversationId} />
              </div>

              {/* Composer */}
              <MessageComposer conversationId={selectedConversationId} />
            </>
          ) : (
            <div className="h-full flex items-center justify-center">
              <div className="text-center">
                <svg
                  className="mx-auto h-12 w-12 text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                  />
                </svg>
                <h3 className="mt-2 text-sm font-medium text-gray-900">
                  Aucune conversation s√©lectionn√©e
                </h3>
                <p className="mt-1 text-sm text-gray-500">
                  Choisissez une conversation dans la liste
                </p>
              </div>
            </div>
          )}
        </div>
      </div>
    </AppShell>
  );
}
```

## 6. Configuration suppl√©mentaire

### `frontend/package.json` (d√©pendances √† ajouter)

```json
{
  "dependencies": {
    "@tanstack/react-query": "^5.17.0",
    "date-fns": "^3.0.0",
    "next": "14.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "autoprefixer": "^10.0.1",
    "postcss": "^8",
    "tailwindcss": "^3.3.0",
    "typescript": "^5"
  }
}
```

### `frontend/.env.local` (√† cr√©er)

```bash
# URL de l'API backend NestJS
# En d√©veloppement, pointer vers http://localhost:3000
# En production, pointer vers votre domaine API
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

### `frontend/middleware.ts` (protection des routes)

```typescript
/**
 * Middleware Next.js pour prot√©ger les routes authentifi√©es
 * Redirige vers /login si pas de token
 */

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const token = request.cookies.get('skybot_token')?.value;
  const isAuthPage = request.nextUrl.pathname.startsWith('/login') || 
                     request.nextUrl.pathname.startsWith('/register');
  const isDashboard = request.nextUrl.pathname.startsWith('/dashboard');

  // Si pas de token et qu'on essaie d'acc√©der au dashboard
  if (!token && isDashboard) {
    return NextResponse.redirect(new URL('/login', request.url));
  }

  // Si token pr√©sent et qu'on est sur une page auth, rediriger vers dashboard
  if (token && isAuthPage) {
    return NextResponse.redirect(new URL('/dashboard', request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/dashboard/:path*', '/login', '/register'],
};
```

### `frontend/app/page.tsx` (page d'accueil - redirection)

```typescript
/**
 * Page d'accueil - redirige vers dashboard ou login
 */

import { redirect } from 'next/navigation';

export default function HomePage() {
  // En production, vous pourriez avoir une vraie landing page ici
  // Pour le MVP, on redirige vers le dashboard (le middleware g√©rera l'auth)
  redirect('/dashboard');
}
```

## 7. Instructions de mise en route

### Installation et d√©marrage

```bash
# 1. Installer les d√©pendances
cd frontend
npm install

# 2. Cr√©er le fichier .env.local
cp .env.example .env.local
# Puis √©diter .env.local pour d√©finir NEXT_PUBLIC_API_URL

# 3. Lancer le serveur de d√©veloppement
npm run dev

# L'application sera accessible sur http://localhost:3001
```

### Configuration requise

**Adaptations n√©cessaires :**

1. **URL de l'API Backend** : Dans `.env.local`, ajustez `NEXT_PUBLIC_API_URL` selon votre configuration :
   - Dev local : `http://localhost:3000/api`
   - Production : `https://api.votre-domaine.com/api`

2. **Gestion du token** : Le token JWT est actuellement stock√© dans `localStorage`. Pour une s√©curit√© accrue en production, vous pourriez :
   - Utiliser des cookies HTTP-only (n√©cessite adaptation backend)
   - Impl√©menter un refresh token

3. **Port Next.js** : Par d√©faut Next.js utilise le port 3000, mais comme votre backend NestJS l'occupe, modifiez dans `package.json` :
   ```json
   "scripts": {
     "dev": "next dev -p 3001",
     "build": "next build",
     "start": "next start -p 3001"
   }
   ```

### Flux d'utilisation

1. **Premi√®re connexion** :
   - Aller sur `/register`
   - Cr√©er un compte (Account + User)
   - Redirection automatique vers `/dashboard`

2. **Connexion suivante** :
   - Aller sur `/login`
   - Se connecter avec email/password
   - Token JWT sauvegard√© dans localStorage
   - Redirection vers `/dashboard`

3. **Dashboard** :
   - Sidebar gauche : liste des inboxes (automatique via API)
   - Colonne centrale : conversations ouvertes (refetch toutes les 10s)
   - Colonne droite : messages de la conversation s√©lectionn√©e (refetch toutes les 5s)
   - Composer : envoie un message via POST API

### Points d'attention

**Ce qui fonctionne** :
- ‚úÖ Auth compl√®te (register, login, logout)
- ‚úÖ Liste des inboxes
- ‚úÖ Liste des conversations
- ‚úÖ Affichage des messages
- ‚úÖ Envoi de messages
- ‚úÖ Distinction visuelle BOT/AGENT/CONTACT
- ‚úÖ Auto-refresh des donn√©es
- ‚úÖ Gestion des erreurs basique

**Ce qui reste √† faire (hors scope MVP)** :
- ‚ùå Filtres de conversations (status, inbox, date)
- ‚ùå Recherche de conversations/messages
- ‚ùå Notifications en temps r√©el (WebSocket/SSE)
- ‚ùå Gestion des pi√®ces jointes
- ‚ùå Profil utilisateur √©ditable
- ‚ùå Gestion d'√©quipe (plusieurs agents)
- ‚ùå Statistiques et analytics

### D√©pannage courant

**Erreur CORS** : Si vous avez des erreurs CORS, v√©rifiez dans votre backend NestJS que les origines sont autoris√©es :
```typescript
// backend/src/main.ts
app.enableCors({
  origin: ['http://localhost:3001'], // Ajouter votre frontend
  credentials: true,
});
```

**Token non reconnu** : V√©rifiez que :
- Le token est bien sauvegard√© dans localStorage (DevTools > Application > Local Storage)
- Le header Authorization est bien envoy√© (DevTools > Network > Headers)
- Le backend valide correctement le JWT

**Donn√©es ne s'affichent pas** : V√©rifiez :
- Que le backend retourne bien les bonnes donn√©es (Postman/curl)
- Que les types TypeScript correspondent aux DTOs backend
- La console navigateur pour les erreurs React Query

---

## R√©sum√© de l'architecture frontend

### Structure des dossiers
```
frontend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx        # Page de connexion
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register/page.tsx     # Page d'inscription
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/page.tsx        # Page principale inbox
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                # Layout racine avec React Query
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Page d'accueil (redirect)
‚îÇ   ‚îî‚îÄ‚îÄ globals.css               # Styles Tailwind
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AppShell.tsx          # Layout app (header + sidebar + main)
‚îÇ   ‚îî‚îÄ‚îÄ inbox/
‚îÇ       ‚îú‚îÄ‚îÄ InboxSidebar.tsx      # Liste des inboxes
‚îÇ       ‚îú‚îÄ‚îÄ ConversationList.tsx  # Liste des conversations
‚îÇ       ‚îú‚îÄ‚îÄ ConversationItem.tsx  # Item conversation
‚îÇ       ‚îú‚îÄ‚îÄ MessageList.tsx       # Liste des messages
‚îÇ       ‚îî‚îÄ‚îÄ MessageComposer.tsx   # Formulaire envoi message
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ apiClient.ts              # Client HTTP avec JWT
‚îÇ   ‚îú‚îÄ‚îÄ queryClient.ts            # Config React Query
‚îÇ   ‚îî‚îÄ‚îÄ types.ts                  # Types TypeScript
‚îî‚îÄ‚îÄ middleware.ts                 # Protection routes auth
```

### Flux de donn√©es
```
User Action ‚Üí Component ‚Üí React Query ‚Üí apiClient ‚Üí Backend API
                ‚Üì                                        ‚Üì
            UI Update ‚Üê Cache Update ‚Üê Response ‚Üê Backend
```

### Points cl√©s
- **Authentification** : JWT stock√© dans localStorage, inject√© automatiquement dans les headers
- **State management** : React Query pour cache serveur, useState pour √©tat local
- **Auto-refresh** : Conversations toutes les 10s, messages toutes les 5s
- **Optimistic updates** : Invalidation de cache apr√®s mutations
- **TypeScript** : Typage strict pour √©viter les erreurs

Vous avez maintenant un frontend **complet et fonctionnel** ! Une fois votre backend NestJS op√©rationnel, vous pourrez tester le flux complet : inscription ‚Üí login ‚Üí voir conversations ‚Üí envoyer messages. üöÄ
