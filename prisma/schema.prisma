generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id               String            @id @default(cuid())
  name             String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  features         Json?
  isDemo           Boolean           @default(false)

  // Multi-tenant subscription fields
  tier             Tier              @default(STARTER)
  status           TenantStatus      @default(TRIAL)
  trialEndsAt      DateTime?

  alerts           Alert[]
  clientConfigs    ClientConfig[]
  contacts         Contact[]
  externalAccounts ExternalAccount[]
  feedbacks        Feedback[]
  inboxes          Inbox[]
  leads            Lead[]
  routingLogs      RoutingLog[]
  userAccounts     UserAccount[]
  modules          TenantModule[]
  integrations     Integration[]
  corporateNumbers CorporateNumber[]
  subscription     Subscription?
  usageTracking    UsageTracking[]
  media            Media[]
  ingestionJobs    IngestionJob[]
  knowledgeItems   KnowledgeItem[]

  @@index([createdAt])
  @@index([isDemo])
  @@index([tier])
  @@index([status])
}

model ExternalAccount {
  id         String   @id @default(cuid())
  accountId  String
  channel    Channel
  externalId String
  clientKey  String
  name       String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, channel, externalId], name: "accountId_channel_externalId")
  @@index([accountId])
  @@index([clientKey])
  @@index([channel])
}

model Inbox {
  id            String         @id @default(cuid())
  accountId     String
  externalId    String
  name          String
  channel       Channel        @default(WHATSAPP)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  contacts      Contact[]
  conversations Conversation[]
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, externalId], name: "accountId_externalId")
  @@index([accountId])
  @@index([channel])
}

model Contact {
  id            String         @id @default(cuid())
  accountId     String
  inboxId       String
  phone         String
  name          String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inbox         Inbox          @relation(fields: [inboxId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([inboxId, phone], name: "inboxId_phone")
  @@index([inboxId])
  @@index([accountId])
}

model Conversation {
  id             String             @id @default(cuid())
  inboxId        String
  contactId      String
  channel        Channel            @default(WHATSAPP)
  externalId     String?
  status         ConversationStatus @default(OPEN)
  lastActivityAt DateTime           @default(now())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  contact        Contact            @relation(fields: [contactId], references: [id], onDelete: Cascade)
  inbox          Inbox              @relation(fields: [inboxId], references: [id], onDelete: Cascade)
  messages       Message[]

  @@unique([channel, externalId], name: "conversation_channel_externalId_unique")
  @@index([inboxId])
  @@index([contactId])
  @@index([channel])
  @@index([externalId])
  @@index([lastActivityAt])
  @@index([status, lastActivityAt])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  channel        Channel
  externalId     String?
  direction      MessageDirection
  from           String?
  to             String?
  text           String?
  timestamp      DateTime         @default(now())
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([channel, externalId], name: "message_channel_externalId_unique")
  @@index([conversationId])
  @@index([externalId])
  @@index([channel])
  @@index([timestamp])
  @@index([conversationId, createdAt])
}

model ClientConfig {
  id               String       @id @default(cuid())
  accountId        String
  clientKey        String
  status           ClientStatus @default(ACTIVE)
  name             String?
  defaultAgentKey  String       @default("master-router")
  allowedAgents    Json
  channels         Json
  externalAccounts Json
  n8nOverrides     Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  account          Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, clientKey], name: "accountId_clientKey")
  @@index([accountId])
  @@index([status])
}

model RoutingLog {
  id                String        @id @default(cuid())
  accountId         String
  requestId         String        @unique
  clientKey         String
  agentKey          String?
  channel           Channel?
  externalAccountId String?
  conversationId    String?
  status            RoutingStatus @default(RECEIVED)
  latencyMs         Int?
  error             String?
  source            String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  account           Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([clientKey])
  @@index([status])
  @@index([createdAt])
  @@index([clientKey, createdAt])
  @@index([status, createdAt])
}

model UserAccount {
  id           String          @id @default(cuid())
  accountId    String
  email        String?
  passwordHash String?
  name         String
  phone        String?
  role         UserRole        @default(USER)
  status       AccountStatus   @default(ACTIVE)
  avatarUrl    String?
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  username     String
  account      Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  preferences  UserPreference?

  @@unique([accountId, username])
  @@index([accountId])
  @@index([role])
  @@index([status])
  @@index([username])
}

model UserPreference {
  id            String      @id @default(cuid())
  userAccountId String      @unique
  theme         Theme       @default(DEFAULT)
  language      Language    @default(EN)
  timezone      String      @default("UTC")
  dateFormat    String      @default("YYYY-MM-DD")
  timeFormat    String      @default("24h")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  userAccount   UserAccount @relation(fields: [userAccountId], references: [id], onDelete: Cascade)
}

model MagicLink {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Lead {
  id          String      @id @default(cuid())
  accountId   String
  name        String
  company     String?
  email       String?
  phone       String?
  status      LeadStatus  @default(NEW)
  temperature Temperature @default(WARM)
  channel     String
  assignedTo  String?
  tags        String[]
  notes       String?
  value       Float?
  currency    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  account     Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([temperature])
  @@index([assignedTo])
  @@index([createdAt])
  @@index([accountId, status])
}

model Feedback {
  id            String         @id @default(cuid())
  accountId     String
  customerName  String
  customerEmail String?
  customerPhone String?
  type          FeedbackType   @default(GENERAL)
  status        FeedbackStatus @default(PENDING)
  rating        Int?
  message       String
  response      String?
  respondedAt   DateTime?
  respondedBy   String?
  channel       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([rating])
  @@index([createdAt])
}

model Alert {
  id             String        @id @default(cuid())
  accountId      String
  type           AlertType
  title          String
  subtitle       String?
  status         AlertStatus   @default(OPEN)
  priority       AlertPriority @default(MEDIUM)
  amount         Float?
  currency       String?
  customerName   String?
  channel        Channel?
  conversationId String?
  assignee       String?
  resolvedAt     DateTime?
  resolvedBy     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  account        Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([assignee])
  @@index([createdAt])
  @@index([accountId, status])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([createdAt])
  @@index([userId])
}

enum ConversationStatus {
  OPEN
  PENDING
  CLOSED
}

enum Channel {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  EMAIL
  WEB
}

enum MessageDirection {
  IN
  OUT
}

enum ClientStatus {
  ACTIVE
  SUSPENDED
}

enum RoutingStatus {
  RECEIVED
  FORWARDED
  FAILED
}

enum UserRole {
  SUPER_ADMIN  // Can manage all tenants
  CLIENT_ADMIN // Can manage their tenant
  AGENT_USER   // Regular user/agent
  ADMIN        // Legacy - kept for backward compatibility
  USER         // Legacy - kept for backward compatibility
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum Tier {
  STARTER
  PRO
  ENTERPRISE
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
  DEFAULT
  NORD
  GOLD
  NATURE
  NETFLIX
  LARACON
  DRACULA
}

enum Language {
  EN
  FR
  ES
  PT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
  WON
}

enum Temperature {
  HOT
  WARM
  COLD
}

enum FeedbackType {
  COMPLAINT
  SUGGESTION
  PRAISE
  QUESTION
  GENERAL
}

enum FeedbackStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum AlertType {
  PAYMENT
  HANDOFF
  SYSTEM
  CUSTOM
}

enum AlertStatus {
  OPEN
  PENDING
  RESOLVED
}

enum AlertPriority {
  HIGH
  MEDIUM
  LOW
}

enum IntegrationProvider {
  SHOPIFY
  WHATSAPP
  AIRTABLE
  STRIPE
  CUSTOM
}

enum IntegrationStatus {
  PENDING
  ACTIVE
  ERROR
  DISABLED
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum IngestionJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum KnowledgeType {
  PRODUCT
  FAQ
  POLICY
  CUSTOM
}

// =========================
// MULTI-TENANT MODULES
// =========================
model TenantModule {
  id        String  @id @default(cuid())
  tenantId  String
  moduleKey String  // "inbox", "crm", "analytics", "shopify", etc.
  enabled   Boolean @default(true)
  limits    Json?   // { maxUsers: 10, messagesPerMonth: 5000 }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, moduleKey])
  @@index([tenantId])
  @@index([moduleKey])
}

// =========================
// INTEGRATIONS
// =========================
model Integration {
  id       String              @id @default(cuid())
  tenantId String
  provider IntegrationProvider
  status   IntegrationStatus   @default(PENDING)

  credentials     String?   // Encrypted JSON with AES-256-GCM
  config          Json?     // Non-sensitive config: { webhookUrl, etc. }
  lastHealthCheck DateTime?
  healthStatus    String?   // "healthy", "degraded", "down"
  errorMessage    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
  @@index([tenantId])
  @@index([provider])
  @@index([status])
}

// =========================
// CORPORATE NUMBERS
// =========================
model CorporateNumber {
  id       String @id @default(cuid())
  tenantId String

  phone          String  // Format: +1234567890
  company        String?
  department     String?
  notes          String?
  autoRespond    Boolean @default(false) // If false, alerts only
  alertOnContact Boolean @default(true)  // Create alert when contacted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
}

// =========================
// SUBSCRIPTION & BILLING
// =========================
model Subscription {
  id       String @id @default(cuid())
  tenantId String @unique

  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?

  tier               Tier     @default(STARTER)
  status             String   @default("trialing") // Stripe statuses: trialing, active, past_due, canceled
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([stripeCustomerId])
  @@index([status])
}

// =========================
// USAGE TRACKING
// =========================
model UsageTracking {
  id       String @id @default(cuid())
  tenantId String

  metric String // "messages_sent", "users", "api_calls", etc.
  value  Int
  period String // "2024-01", "2024-W05", "2024-01-26"

  createdAt DateTime @default(now())

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metric, period])
  @@index([tenantId])
  @@index([metric])
  @@index([period])
}

// =========================
// MEDIA STORAGE
// =========================
model Media {
  id       String @id @default(cuid())
  tenantId String

  fileUrl      String    // S3/R2 URL
  fileName     String
  type         MediaType
  mimeType     String?
  size         Int?      // bytes
  source       String?   // "whatsapp", "shopify", "upload"
  sourceId     String?   // External ID from source
  thumbnailUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([source])
  @@index([sourceId])
}

// =========================
// INGESTION JOBS
// =========================
model IngestionJob {
  id       String             @id @default(cuid())
  tenantId String
  status   IngestionJobStatus @default(PENDING)

  type           String  // "shopify_products", "airtable_faq", "manual_upload"
  source         String? // URL or identifier
  progress       Int     @default(0) // 0-100
  itemsProcessed Int     @default(0)
  itemsTotal     Int     @default(0)
  errorMessage   String?
  metadata       Json?   // Additional context

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// =========================
// KNOWLEDGE BASE
// =========================
model KnowledgeItem {
  id       String        @id @default(cuid())
  tenantId String
  type     KnowledgeType @default(CUSTOM)

  title     String
  content   String   // Main content (could be markdown)
  tags      String[] // PostgreSQL array
  metadata  Json?    // Additional structured data
  sourceUrl String?  // Original source URL
  embedding String?  // Vector embedding for semantic search (future)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Account @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([tags])
  @@index([createdAt])
}
