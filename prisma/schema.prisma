generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =========================
// ACCOUNT
// =========================

model Account {
  id        String   @id @default(cuid())
  name      String
  isDemo    Boolean  @default(false) // Demo account flag
  features  Json?    // Feature toggles: { crm: true, analytics: true, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientConfigs    ClientConfig[]
  routingLogs      RoutingLog[]
  externalAccounts ExternalAccount[]

  inboxes  Inbox[]
  contacts Contact[]

  // New relations
  userAccounts UserAccount[]
  leads        Lead[]
  feedbacks    Feedback[]
  alerts       Alert[]

  @@index([createdAt])
  @@index([isDemo])
}

model ExternalAccount {
  id         String  @id @default(cuid())
  accountId  String
  channel    Channel
  externalId String
  clientKey  String

  name     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, channel, externalId], name: "accountId_channel_externalId")
  @@index([accountId])
  @@index([clientKey])
  @@index([channel])
}

// =========================
// INBOX
// =========================

model Inbox {
  id         String  @id @default(cuid())
  accountId  String
  externalId String
  name       String
  channel    Channel @default(WHATSAPP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contacts      Contact[]
  conversations Conversation[]

  @@unique([accountId, externalId], name: "accountId_externalId")
  @@index([accountId])
  @@index([channel])
}

// =========================
// CONTACT
// =========================

model Contact {
  id        String  @id @default(cuid())
  accountId String
  inboxId   String
  phone     String
  name      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inbox         Inbox          @relation(fields: [inboxId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([inboxId, phone], name: "inboxId_phone")
  @@index([inboxId])
  @@index([accountId])
}

// =========================
// CONVERSATION
// =========================
model Conversation {
  id String @id @default(cuid())

  inboxId   String
  contactId String

  channel    Channel @default(WHATSAPP)
  externalId String? // id conversation côté provider

  status         ConversationStatus @default(OPEN)
  lastActivityAt DateTime           @default(now())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  inbox    Inbox     @relation(fields: [inboxId], references: [id], onDelete: Cascade)
  contact  Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([channel, externalId], name: "conversation_channel_externalId_unique")
  @@index([inboxId])
  @@index([contactId])
  @@index([channel])
  @@index([externalId])
  @@index([lastActivityAt])
  @@index([status, lastActivityAt])
}

// =========================
// MESSAGE
// =========================
model Message {
  id String @id @default(cuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  channel    Channel
  externalId String? // id message provider

  direction MessageDirection
  from      String?
  to        String?
  text      String?

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@unique([channel, externalId], name: "message_channel_externalId_unique")
  @@index([conversationId])
  @@index([externalId])
  @@index([channel])
  @@index([timestamp])
  @@index([conversationId, createdAt])
}

// =========================
// CLIENT CONFIG
// =========================

model ClientConfig {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  clientKey String
  status    ClientStatus @default(ACTIVE)
  name      String?

  defaultAgentKey String @default("master-router")

  allowedAgents    Json
  channels         Json
  externalAccounts Json
  n8nOverrides     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, clientKey], name: "accountId_clientKey")
  @@index([accountId])
  @@index([status])
}

// =========================
// ROUTING LOGS
// =========================

model RoutingLog {
  id                String        @id @default(cuid())
  accountId         String
  requestId         String        @unique
  clientKey         String
  agentKey          String?
  channel           Channel?
  externalAccountId String?
  conversationId    String?
  status            RoutingStatus @default(RECEIVED)
  latencyMs         Int?
  error             String?
  source            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([clientKey])
  @@index([status])
  @@index([createdAt])
  @@index([clientKey, createdAt])
  @@index([status, createdAt])
}

// =========================
// ENUMS
// =========================
enum ConversationStatus {
  OPEN
  PENDING
  CLOSED
}

enum Channel {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  EMAIL
  WEB
}

enum MessageDirection {
  IN
  OUT
}

enum ClientStatus {
  ACTIVE
  SUSPENDED
}

enum RoutingStatus {
  RECEIVED
  FORWARDED
  FAILED
}

// =========================
// USER ACCOUNT (Admin/User)
// =========================
model UserAccount {
  id        String @id @default(cuid())
  accountId String // Links to business Account

  email        String
  passwordHash String?
  name         String
  phone        String?
  role         UserRole      @default(USER)
  status       AccountStatus @default(ACTIVE)
  avatarUrl    String?
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account     Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  preferences UserPreference?

  @@unique([accountId, email], name: "accountId_email")
  @@index([accountId])
  @@index([email])
  @@index([role])
  @@index([status])
}

// =========================
// USER PREFERENCES
// =========================
model UserPreference {
  id            String @id @default(cuid())
  userAccountId String @unique

  theme      Theme    @default(DEFAULT)
  language   Language @default(EN)
  timezone   String   @default("UTC")
  dateFormat String   @default("YYYY-MM-DD")
  timeFormat String   @default("24h")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userAccount UserAccount @relation(fields: [userAccountId], references: [id], onDelete: Cascade)
}

// =========================
// CRM - LEADS
// =========================
model Lead {
  id        String @id @default(cuid())
  accountId String

  name        String
  company     String?
  email       String?
  phone       String?
  status      LeadStatus  @default(NEW)
  temperature Temperature @default(WARM)
  channel     String
  assignedTo  String?
  tags        String[] // PostgreSQL array
  notes       String?
  value       Float?
  currency    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([temperature])
  @@index([assignedTo])
  @@index([createdAt])
  @@index([accountId, status])
}

// =========================
// CRM - FEEDBACK
// =========================
model Feedback {
  id        String @id @default(cuid())
  accountId String

  customerName  String
  customerEmail String?
  customerPhone String?
  type          FeedbackType   @default(GENERAL)
  status        FeedbackStatus @default(PENDING)
  rating        Int? // 1-5
  message       String
  response      String?
  respondedAt   DateTime?
  respondedBy   String?
  channel       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([rating])
  @@index([createdAt])
}

// =========================
// ALERTS
// =========================
model Alert {
  id        String @id @default(cuid())
  accountId String

  type           AlertType
  title          String
  subtitle       String?
  status         AlertStatus   @default(OPEN)
  priority       AlertPriority @default(MEDIUM)
  amount         Float?
  currency       String?
  customerName   String?
  channel        Channel?
  conversationId String?
  assignee       String?
  resolvedAt     DateTime?
  resolvedBy     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([assignee])
  @@index([createdAt])
  @@index([accountId, status])
}

// =========================
// NEW ENUMS
// =========================
enum UserRole {
  ADMIN
  USER
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum Theme {
  DEFAULT   // The default shadcn/ui theme
  NORD      // An arctic, north-bluish color palette
  GOLD      // A warm and inviting color palette of rich browns and shimmering golds
  NATURE    // A soothing palette of soft yellows, greens, and blues
  NETFLIX   // A bold color palette of black, white, and fiery red
  LARACON   // A vibrant color palette celebrating Laracon US 2023
  DRACULA   // A dark theme using Dracula colors
  LIGHT     // Legacy - kept for backward compatibility
  DARK      // Legacy - kept for backward compatibility
  SYSTEM    // Legacy - kept for backward compatibility
}

enum Language {
  EN
  FR
  ES
  PT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
  WON
}

enum Temperature {
  HOT
  WARM
  COLD
}

enum FeedbackType {
  COMPLAINT
  SUGGESTION
  PRAISE
  QUESTION
  GENERAL
}

enum FeedbackStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum AlertType {
  PAYMENT
  HANDOFF
  SYSTEM
  CUSTOM
}

enum AlertStatus {
  OPEN
  PENDING
  RESOLVED
}

enum AlertPriority {
  HIGH
  MEDIUM
  LOW
}
