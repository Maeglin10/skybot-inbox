generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ACCOUNT
 * =========================
 */
model Account {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inboxes  Inbox[]
  contacts Contact[]

  @@index([createdAt])
}

/**
 * =========================
 * INBOX
 * =========================
 */
model Inbox {
  id         String  @id @default(cuid())
  accountId  String
  externalId String
  name       String
  channel    Channel @default(WHATSAPP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contacts      Contact[]
  conversations Conversation[]

  @@unique([accountId, externalId], name: "accountId_externalId")
  @@index([accountId])
  @@index([channel])
}

/**
 * =========================
 * CONTACT
 * =========================
 */
model Contact {
  id        String  @id @default(cuid())
  accountId String
  inboxId   String
  phone     String
  name      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inbox         Inbox          @relation(fields: [inboxId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([inboxId, phone], name: "inboxId_phone")
  @@index([inboxId])
  @@index([accountId])
}

/**
 * =========================
 * CONVERSATION
 * =========================
 */
model Conversation {
  id String @id @default(cuid())

  inboxId   String
  contactId String

  channel    Channel @default(WHATSAPP)
  externalId String? // id conversation côté provider

  status         ConversationStatus @default(OPEN)
  lastActivityAt DateTime           @default(now())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  inbox    Inbox     @relation(fields: [inboxId], references: [id], onDelete: Cascade)
  contact  Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([channel, externalId], name: "conversation_channel_externalId_unique")
  @@index([inboxId])
  @@index([contactId])
  @@index([channel])
  @@index([externalId])
}

/**
 * =========================
 * MESSAGE
 * =========================
 */
model Message {
  id String @id @default(cuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  channel    Channel
  externalId String? // id message provider

  direction MessageDirection
  from      String?
  to        String?
  text      String?

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@unique([channel, externalId], name: "message_channel_externalId_unique")
  @@index([conversationId])
  @@index([externalId])
  @@index([channel])
}

/**
 * =========================
 * ENUMS
 * =========================
 */
enum ConversationStatus {
  OPEN
  PENDING
  CLOSED
}

enum Channel {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  EMAIL
  WEB
}

enum MessageDirection {
  IN
  OUT
}
